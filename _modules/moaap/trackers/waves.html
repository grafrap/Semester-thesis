

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>moaap.trackers.waves &mdash; MOAAP  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../../../_static/doctools.js?v=9a2dae69"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            MOAAP
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">MOAAP Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial.html">MOAAP: Multi-Object Analysis of Atmospheric Phenomena - Tutorial</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">MOAAP</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">moaap.trackers.waves</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for moaap.trackers.waves</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy</span><span class="w"> </span><span class="kn">import</span> <span class="n">fftpack</span><span class="p">,</span> <span class="n">ndimage</span><span class="p">,</span> <span class="n">signal</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">moaap.utils.constants</span><span class="w"> </span><span class="kn">import</span> <span class="n">g</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">pi</span><span class="p">,</span> <span class="n">NA</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">moaap.utils.data_proc</span><span class="w"> </span><span class="kn">import</span> <span class="n">tukey_latitude_mask</span><span class="p">,</span> <span class="n">temporal_tukey_window</span><span class="p">,</span> <span class="n">interpolate_temporal</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">moaap.utils.segmentation</span><span class="w"> </span><span class="kn">import</span> <span class="n">watershed_3d_overlap_parallel</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">moaap.utils.object_props</span><span class="w"> </span><span class="kn">import</span> <span class="n">clean_up_objects</span><span class="p">,</span> <span class="n">BreakupObjects</span><span class="p">,</span> <span class="n">ConnectLon_on_timestep</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">gc</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>

<div class="viewcode-block" id="track_tropwaves_tb">
<a class="viewcode-back" href="../../../modules.html#moaap.trackers.waves.track_tropwaves_tb">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">track_tropwaves_tb</span><span class="p">(</span><span class="n">tb</span><span class="p">,</span>
                   <span class="n">Lat</span><span class="p">,</span>
                   <span class="n">connectLon</span><span class="p">,</span>
                   <span class="n">dT</span><span class="p">,</span>
                   <span class="n">Gridspacing</span><span class="p">,</span>
                   <span class="n">er_th</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">,</span>  
                   <span class="n">mrg_th</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">,</span> 
                   <span class="n">igw_th</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span>  
                   <span class="n">kel_th</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>  
                   <span class="n">eig0_th</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span> 
                   <span class="n">breakup</span> <span class="o">=</span> <span class="s1">&#39;watershed&#39;</span><span class="p">,</span>
                   <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Identifies and tracks tropical waves using wavenumber-frequency filtering </span>
<span class="sd">    (Wheeler &amp; Kiladis method) applied to precipitation data.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pr : np.ndarray</span>
<span class="sd">        Precipitation data.</span>
<span class="sd">    Lat : np.ndarray</span>
<span class="sd">        Latitude grid.</span>
<span class="sd">    dT : int</span>
<span class="sd">        Time step (hours).</span>
<span class="sd">    er_th, mrg_th, igw_th, kel_th, eig0_th : float</span>
<span class="sd">        Amplitude thresholds for identifying Equatorial Rossby, Mixed Rossby Gravity, </span>
<span class="sd">        Inertia Gravity, Kelvin, and Eastward Inertia Gravity waves respectively.</span>
<span class="sd">    breakup : str</span>
<span class="sd">        Method to handle merging objects (&#39;breakup&#39; or &#39;watershed&#39;).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    mrg_objects, igw_objects, kelvin_objects, eig0_objects, er_objects : np.ndarray</span>
<span class="sd">        Labeled object arrays for each wave type.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">tb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">tb</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>   <span class="c1"># very first line in the function</span>

    <span class="n">ew_mintime</span> <span class="o">=</span> <span class="mi">32</span>
    
    <span class="c1"># use Turkey (hals cos) function to tamper region</span>
    <span class="n">lat_mask</span> <span class="o">=</span> <span class="n">tukey_latitude_mask</span><span class="p">(</span><span class="n">Lat</span><span class="p">,</span> <span class="n">lat_start</span><span class="o">=</span><span class="mf">17.0</span><span class="p">,</span> <span class="n">lat_stop</span><span class="o">=</span><span class="mf">25.0</span><span class="p">)</span>
    <span class="n">tb_eq</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">tb_eq</span><span class="p">[</span><span class="n">tb_eq</span> <span class="o">&gt;</span> <span class="mi">350</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">tb_eq</span><span class="p">[</span><span class="n">tb_eq</span> <span class="o">&lt;</span> <span class="mi">150</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="c1"># compute anomalies</span>
    <span class="n">tb_eq</span> <span class="o">=</span> <span class="n">tb_eq</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">tb_eq</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">tb_eq</span> <span class="o">=</span> <span class="n">tb_eq</span> <span class="o">*</span> <span class="n">lat_mask</span><span class="p">[</span><span class="kc">None</span><span class="p">,:]</span>
    <span class="n">tb_eq</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">tb_eq</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    valid = (tb_eq &gt;= 150) &amp; (tb_eq &lt;= 350)                   # bool view</span>
<span class="sd">    # mean over valid points only, without building a big masked array:</span>
<span class="sd">    sum_ = np.sum(np.where(valid, tb_eq, 0.0), axis=(1,2), keepdims=True, dtype=np.float32)</span>
<span class="sd">    cnt_ = np.sum(valid,                    axis=(1,2), keepdims=True, dtype=np.int32)</span>
<span class="sd">    mean_ = sum_ / np.maximum(cnt_, 1)</span>
<span class="sd">    </span>
<span class="sd">    tb_eq -= mean_.astype(np.float32, copy=False)             # center</span>
<span class="sd">    tb_eq *= valid.astype(np.float32)                         # zero outside valid, no NaNs</span>
<span class="sd">    </span>
<span class="sd">    # 3) apply &amp; renormalize</span>
<span class="sd">    w2 = np.mean(lat_mask**2)</span>
<span class="sd">    tb_eq = (lat_mask * tb_eq) / np.sqrt(w2)</span>
<span class="sd">    &quot;&quot;&quot;</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    tb_eq = tb.copy()</span>
<span class="sd">    tb_eq[:,np.abs(Lat[:,0]) &gt; 20] = 0</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># pad the Tb to avoid boundary effects</span>
    <span class="c1"># temporal turkey tapping:</span>
    <span class="n">nt</span> <span class="o">=</span> <span class="n">tb_eq</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">win</span> <span class="o">=</span> <span class="n">temporal_tukey_window</span><span class="p">(</span><span class="n">nt</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
    <span class="n">tb_eq</span> <span class="o">=</span> <span class="n">tb_eq</span> <span class="o">*</span> <span class="n">win</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
    <span class="n">pad_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tb_eq</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.2</span><span class="p">)</span>
    <span class="n">tb_eq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">tb_eq</span><span class="p">,</span> <span class="p">((</span><span class="n">pad_size</span><span class="p">,</span><span class="n">pad_size</span><span class="p">),(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)),</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;reflect&#39;</span><span class="p">)</span>
     
    <span class="n">tb_eq</span> <span class="o">=</span> <span class="n">interpolate_temporal</span><span class="p">(</span><span class="n">tb_eq</span><span class="p">)</span>
    <span class="n">tropical_waves</span> <span class="o">=</span> <span class="n">KFfilter</span><span class="p">(</span><span class="n">tb_eq</span><span class="p">,</span>
                     <span class="nb">int</span><span class="p">(</span><span class="mi">24</span><span class="o">/</span><span class="n">dT</span><span class="p">))</span>

    <span class="n">wave_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ER&#39;</span><span class="p">,</span><span class="s1">&#39;MRG&#39;</span><span class="p">,</span><span class="s1">&#39;IGW&#39;</span><span class="p">,</span><span class="s1">&#39;Kelvin&#39;</span><span class="p">,</span><span class="s1">&#39;Eig0&#39;</span><span class="p">]</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;        track tropical waves&#39;</span><span class="p">)</span>
    <span class="n">rgiObj_Struct</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">));</span> <span class="n">rgiObj_Struct</span><span class="p">[:,:,:]</span><span class="o">=</span><span class="mi">1</span>
    <span class="k">for</span> <span class="n">wa</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;            work on &#39;</span> <span class="o">+</span> <span class="n">wave_names</span><span class="p">[</span><span class="n">wa</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">wa</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">amplitude</span> <span class="o">=</span> <span class="n">KFfilter</span><span class="o">.</span><span class="n">erfilter</span><span class="p">(</span><span class="n">tropical_waves</span><span class="p">,</span> <span class="n">fmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kmin</span><span class="o">=-</span><span class="mi">10</span><span class="p">,</span> <span class="n">kmax</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">hmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">hmax</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># had to set hmin from 8 to 0</span>
            <span class="n">wave</span> <span class="o">=</span> <span class="n">amplitude</span><span class="p">[</span><span class="n">pad_size</span><span class="p">:</span><span class="o">-</span><span class="n">pad_size</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">er_th</span>
            <span class="n">threshold</span> <span class="o">=</span> <span class="n">er_th</span>
        <span class="k">if</span> <span class="n">wa</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">amplitude</span> <span class="o">=</span> <span class="n">KFfilter</span><span class="o">.</span><span class="n">mrgfilter</span><span class="p">(</span><span class="n">tropical_waves</span><span class="p">)</span>
            <span class="n">wave</span> <span class="o">=</span> <span class="n">amplitude</span><span class="p">[</span><span class="n">pad_size</span><span class="p">:</span><span class="o">-</span><span class="n">pad_size</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">mrg_th</span>
            <span class="n">threshold</span> <span class="o">=</span> <span class="n">mrg_th</span>
        <span class="k">elif</span> <span class="n">wa</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">amplitude</span> <span class="o">=</span> <span class="n">KFfilter</span><span class="o">.</span><span class="n">igfilter</span><span class="p">(</span><span class="n">tropical_waves</span><span class="p">)</span>
            <span class="n">wave</span> <span class="o">=</span> <span class="n">amplitude</span><span class="p">[</span><span class="n">pad_size</span><span class="p">:</span><span class="o">-</span><span class="n">pad_size</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">igw_th</span>
            <span class="n">threshold</span> <span class="o">=</span> <span class="n">igw_th</span>
        <span class="k">elif</span> <span class="n">wa</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">amplitude</span> <span class="o">=</span> <span class="n">KFfilter</span><span class="o">.</span><span class="n">kelvinfilter</span><span class="p">(</span><span class="n">tropical_waves</span><span class="p">)</span>
            <span class="n">wave</span> <span class="o">=</span> <span class="n">amplitude</span><span class="p">[</span><span class="n">pad_size</span><span class="p">:</span><span class="o">-</span><span class="n">pad_size</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">kel_th</span>
            <span class="n">threshold</span> <span class="o">=</span> <span class="n">kel_th</span>
        <span class="k">elif</span> <span class="n">wa</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">amplitude</span> <span class="o">=</span> <span class="n">KFfilter</span><span class="o">.</span><span class="n">eig0filter</span><span class="p">(</span><span class="n">tropical_waves</span><span class="p">)</span>
            <span class="n">wave</span> <span class="o">=</span> <span class="n">amplitude</span><span class="p">[</span><span class="n">pad_size</span><span class="p">:</span><span class="o">-</span><span class="n">pad_size</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">eig0_th</span>
            <span class="n">threshold</span> <span class="o">=</span> <span class="n">eig0_th</span>

        <span class="n">amplitude</span> <span class="o">=</span> <span class="n">amplitude</span><span class="p">[</span><span class="n">pad_size</span><span class="p">:</span><span class="o">-</span><span class="n">pad_size</span><span class="p">]</span>
        <span class="n">rgiObjectsUD</span><span class="p">,</span> <span class="n">nr_objectsUD</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">wave</span><span class="p">,</span> <span class="n">structure</span><span class="o">=</span><span class="n">rgiObj_Struct</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;                &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">nr_objectsUD</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; object found&#39;</span><span class="p">)</span>

        <span class="n">wave_objects</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">clean_up_objects</span><span class="p">(</span><span class="n">rgiObjectsUD</span><span class="p">,</span>
                              <span class="n">dT</span><span class="p">,</span>
                              <span class="n">min_tsteps</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">ew_mintime</span><span class="o">/</span><span class="n">dT</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">breakup</span> <span class="o">==</span> <span class="s1">&#39;breakup&#39;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;                break up long tropical waves that have many elements&#39;</span><span class="p">)</span>
            <span class="n">wave_objects</span><span class="p">,</span> <span class="n">object_split</span> <span class="o">=</span> <span class="n">BreakupObjects</span><span class="p">(</span><span class="n">wave_objects</span><span class="p">,</span>
                                    <span class="nb">int</span><span class="p">(</span><span class="n">ew_mintime</span><span class="o">/</span><span class="n">dT</span><span class="p">),</span>
                                    <span class="n">dT</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">breakup</span> <span class="o">==</span> <span class="s1">&#39;watershed&#39;</span><span class="p">:</span>
            <span class="c1"># threshold=0.1</span>
            <span class="n">min_dist</span><span class="o">=</span><span class="nb">int</span><span class="p">((</span><span class="mi">1000</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span><span class="o">/</span><span class="n">Gridspacing</span><span class="p">)</span>
            <span class="n">wave_amp</span> <span class="o">=</span> <span class="n">amplitude</span>
            <span class="c1">#wave_amp[rgiObjectsUD == 0] = 0</span>
            <span class="n">wave_objects</span> <span class="o">=</span> <span class="n">watershed_3d_overlap_parallel</span><span class="p">(</span>
                    <span class="n">wave_amp</span> <span class="o">*-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">threshold</span><span class="p">),</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">threshold</span><span class="p">),</span>
                    <span class="n">min_dist</span><span class="p">,</span>
                    <span class="n">dT</span><span class="p">,</span>
                    <span class="n">mintime</span> <span class="o">=</span> <span class="n">ew_mintime</span><span class="p">,</span>
                    <span class="p">)</span>
            
        <span class="k">if</span> <span class="n">connectLon</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;                connect waves objects over date line&#39;</span><span class="p">)</span>
            <span class="n">wave_objects</span> <span class="o">=</span> <span class="n">ConnectLon_on_timestep</span><span class="p">(</span><span class="n">wave_objects</span><span class="p">)</span>

        <span class="n">wave_objects</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">clean_up_objects</span><span class="p">(</span><span class="n">wave_objects</span><span class="p">,</span>
                          <span class="n">dT</span><span class="p">,</span>
                          <span class="n">min_tsteps</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">ew_mintime</span><span class="o">/</span><span class="n">dT</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">wa</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">er_objects</span> <span class="o">=</span> <span class="n">wave_objects</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">wa</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">mrg_objects</span> <span class="o">=</span> <span class="n">wave_objects</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">wa</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">igw_objects</span> <span class="o">=</span> <span class="n">wave_objects</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">wa</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">kelvin_objects</span> <span class="o">=</span> <span class="n">wave_objects</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">wa</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">eig0_objects</span> <span class="o">=</span> <span class="n">wave_objects</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">del</span> <span class="n">wave</span>
        <span class="k">del</span> <span class="n">wave_objects</span>
        <span class="k">del</span> <span class="n">rgiObjectsUD</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">mrg_objects</span><span class="p">,</span> <span class="n">igw_objects</span><span class="p">,</span> <span class="n">kelvin_objects</span><span class="p">,</span> <span class="n">eig0_objects</span><span class="p">,</span> <span class="n">er_objects</span></div>


<div class="viewcode-block" id="KFfilter">
<a class="viewcode-back" href="../../../modules.html#moaap.trackers.waves.KFfilter">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">KFfilter</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;class for wavenumber-frequency filtering for WK99 and WKH00&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">datain</span><span class="p">,</span> <span class="n">spd</span><span class="p">,</span> <span class="n">tim_taper</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Arguments:</span>
<span class="sd">        </span>
<span class="sd">       &#39;datain&#39;    -- the data to be filtered. dimension must be (time, lat, lon)</span>

<span class="sd">       &#39;spd&#39;       -- samples per day</span>

<span class="sd">       &#39;tim_taper&#39; -- tapering ratio by cos. applay tapering first and last tim_taper%</span>
<span class="sd">                      samples. default is cos20 tapering</span>

<span class="sd">                      &quot;&quot;&quot;</span>
        <span class="n">ntim</span><span class="p">,</span> <span class="n">nlat</span><span class="p">,</span> <span class="n">nlon</span> <span class="o">=</span> <span class="n">datain</span><span class="o">.</span><span class="n">shape</span>

        <span class="c1">#remove the lowest three harmonics of the seasonal cycle (WK99, WKW03)</span>
<span class="c1">##         if ntim &gt; 365*spd/3:</span>
<span class="c1">##             rf = fftpack.rfft(datain,axis=0)</span>
<span class="c1">##             freq = fftpack.rfftfreq(ntim*spd, d=1./float(spd))</span>
<span class="c1">##             rf[(freq &lt;= 3./365) &amp; (freq &gt;=1./365),:,:] = 0.0     #freq&lt;=3./365 only??</span>
<span class="c1">##             datain = fftpack.irfft(rf,axis=0)</span>

        <span class="c1">#remove dominal trend</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">detrend</span><span class="p">(</span><span class="n">datain</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1">#tapering</span>
        <span class="k">if</span> <span class="n">tim_taper</span> <span class="o">==</span> <span class="s1">&#39;hann&#39;</span><span class="p">:</span>
            <span class="n">window</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">hann</span><span class="p">(</span><span class="n">ntim</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span> <span class="o">*</span> <span class="n">window</span><span class="p">[:,</span><span class="n">NA</span><span class="p">,</span><span class="n">NA</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">tim_taper</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1">#taper by cos tapering same dtype as input array</span>
            <span class="n">tp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ntim</span><span class="o">*</span><span class="n">tim_taper</span><span class="p">)</span>
            <span class="n">window</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">ntim</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">datain</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">tp</span><span class="p">)</span>
            <span class="n">window</span><span class="p">[:</span><span class="n">tp</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">pi</span><span class="o">/</span><span class="n">tp</span><span class="p">))</span>
            <span class="n">window</span><span class="p">[</span><span class="o">-</span><span class="n">tp</span><span class="p">:]</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">x</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">pi</span><span class="o">/</span><span class="n">tp</span><span class="p">))</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span> <span class="o">*</span> <span class="n">window</span><span class="p">[:,</span><span class="n">NA</span><span class="p">,</span><span class="n">NA</span><span class="p">]</span>

        <span class="c1">#FFT</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fftdata</span> <span class="o">=</span> <span class="n">fftpack</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>

        <span class="c1">#Note</span>
        <span class="c1"># fft is defined by exp(-ikx), so to adjust exp(ikx) multipried minus         </span>
        <span class="n">wavenumber</span> <span class="o">=</span> <span class="o">-</span><span class="n">fftpack</span><span class="o">.</span><span class="n">fftfreq</span><span class="p">(</span><span class="n">nlon</span><span class="p">)</span><span class="o">*</span><span class="n">nlon</span>
        <span class="n">frequency</span> <span class="o">=</span> <span class="n">fftpack</span><span class="o">.</span><span class="n">fftfreq</span><span class="p">(</span><span class="n">ntim</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="mf">1.</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">spd</span><span class="p">))</span>
        <span class="n">knum</span><span class="p">,</span> <span class="n">freq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">wavenumber</span><span class="p">,</span> <span class="n">frequency</span><span class="p">)</span>

        <span class="c1">#make f&lt;0 domain same as f&gt;0 domain</span>
        <span class="c1">#CAUTION: wave definition is exp(i(k*x-omega*t)) but FFT definition exp(-ikx)</span>
        <span class="c1">#so cahnge sign</span>
        <span class="n">knum</span><span class="p">[</span><span class="n">freq</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">knum</span><span class="p">[</span><span class="n">freq</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">freq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">freq</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">knum</span> <span class="o">=</span> <span class="n">knum</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">freq</span> <span class="o">=</span> <span class="n">freq</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">wavenumber</span> <span class="o">=</span> <span class="n">wavenumber</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">frequency</span>

<div class="viewcode-block" id="KFfilter.decompose_antisymm">
<a class="viewcode-back" href="../../../modules.html#moaap.trackers.waves.KFfilter.decompose_antisymm">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">decompose_antisymm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        decompose attribute data to sym and antisym component.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fftdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fftdata</span>
        <span class="n">nf</span><span class="p">,</span> <span class="n">nlat</span><span class="p">,</span> <span class="n">nk</span> <span class="o">=</span> <span class="n">fftdata</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">symm</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">fftdata</span><span class="p">[:,:</span><span class="n">nlat</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">+</span> <span class="n">fftdata</span><span class="p">[:,</span><span class="n">nlat</span><span class="p">:</span><span class="n">nlat</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,:])</span>  
        <span class="n">anti</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">fftdata</span><span class="p">[:,:</span><span class="n">nlat</span><span class="o">/</span><span class="mi">2</span><span class="p">,:]</span> <span class="o">-</span> <span class="n">fftdata</span><span class="p">[:,</span><span class="n">nlat</span><span class="p">:</span><span class="n">nlat</span><span class="o">/</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,:])</span> 
        
        <span class="bp">self</span><span class="o">.</span><span class="n">fftdata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">anti</span><span class="p">,</span> <span class="n">symm</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div>


<div class="viewcode-block" id="KFfilter.kfmask">
<a class="viewcode-back" href="../../../modules.html#moaap.trackers.waves.KFfilter.kfmask">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">kfmask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kmax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;return wavenumber-frequency mask for wavefilter method</span>

<span class="sd">        Arguments:</span>

<span class="sd">           &#39;fmin/fmax&#39; --</span>

<span class="sd">           &#39;kmin/kmax&#39; --</span>

<span class="sd">        Returns:</span>
<span class="sd">              &#39;mask&#39; -- 2D boolean array (wavenumber, frequency).domain to be filterd</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nf</span><span class="p">,</span> <span class="n">nlat</span><span class="p">,</span> <span class="n">nk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fftdata</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">knum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">knum</span>
        <span class="n">freq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">freq</span>

        <span class="c1">#wavenumber cut-off</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nf</span><span class="p">,</span><span class="n">nk</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">kmin</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">|</span> <span class="p">(</span><span class="n">knum</span> <span class="o">&lt;</span> <span class="n">kmin</span><span class="p">)</span> 
        <span class="k">if</span> <span class="n">kmax</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">|</span> <span class="p">(</span><span class="n">kmax</span> <span class="o">&lt;</span> <span class="n">knum</span><span class="p">)</span>

        <span class="c1">#frequency cutoff</span>
        <span class="k">if</span> <span class="n">fmin</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">|</span> <span class="p">(</span><span class="n">freq</span> <span class="o">&lt;</span> <span class="n">fmin</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fmax</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">|</span> <span class="p">(</span><span class="n">fmax</span> <span class="o">&lt;</span> <span class="n">freq</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">mask</span></div>


<div class="viewcode-block" id="KFfilter.wavefilter">
<a class="viewcode-back" href="../../../modules.html#moaap.trackers.waves.KFfilter.wavefilter">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">wavefilter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mask</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;apply wavenumber-frequency filtering by original mask.</span>
<span class="sd">        </span>
<span class="sd">        Arguments:</span>
<span class="sd">        </span>
<span class="sd">           &#39;mask&#39; -- 2D boolean array (wavenumber, frequency).domain to be filterd</span>
<span class="sd">                     is False (True member to be zero)</span>
<span class="sd">        Returns:</span>
<span class="sd">              &#39;filterd&#39; -- filtered data in the original data space</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">wavenumber</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wavenumber</span>
        <span class="n">frequency</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frequency</span>
        <span class="n">fftdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fftdata</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">nf</span><span class="p">,</span> <span class="n">nlat</span><span class="p">,</span> <span class="n">nk</span> <span class="o">=</span> <span class="n">fftdata</span><span class="o">.</span><span class="n">shape</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">nf</span><span class="p">,</span> <span class="n">nk</span><span class="p">)</span> <span class="o">!=</span> <span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;mask array size is incorrect.&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">mask</span><span class="p">[:,</span><span class="n">NA</span><span class="p">,:],</span> <span class="n">nlat</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>    
        <span class="n">fftdata</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="c1">#inverse FFT</span>
        <span class="n">filterd</span> <span class="o">=</span> <span class="n">fftpack</span><span class="o">.</span><span class="n">ifft2</span><span class="p">(</span><span class="n">fftdata</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">filterd</span><span class="o">.</span><span class="n">real</span></div>


    <span class="c1">#filter</span>
<div class="viewcode-block" id="KFfilter.kelvinfilter">
<a class="viewcode-back" href="../../../modules.html#moaap.trackers.waves.KFfilter.kelvinfilter">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">kelvinfilter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fmin</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">fmax</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">kmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kmax</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">hmin</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">hmax</span><span class="o">=</span><span class="mi">90</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;kelvin wave filter</span>

<span class="sd">        Arguments:</span>

<span class="sd">           &#39;fmin/fmax&#39; -- unit is cycle per day</span>

<span class="sd">           &#39;kmin/kmax&#39; -- zonal wave number</span>

<span class="sd">           &#39;hmin/hmax&#39; --equivalent depth</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">              &#39;filterd&#39; -- filtered data in the original data space</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">fftdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fftdata</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">knum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">knum</span>
        <span class="n">freq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">freq</span>
        <span class="n">nf</span><span class="p">,</span> <span class="n">nlat</span><span class="p">,</span> <span class="n">nk</span> <span class="o">=</span> <span class="n">fftdata</span><span class="o">.</span><span class="n">shape</span>

        <span class="c1"># filtering ############################################################</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nf</span><span class="p">,</span><span class="n">nk</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="c1">#wavenumber cut-off</span>
        <span class="k">if</span> <span class="n">kmin</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">|</span> <span class="p">(</span><span class="n">knum</span> <span class="o">&lt;</span> <span class="n">kmin</span><span class="p">)</span> 
        <span class="k">if</span> <span class="n">kmax</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">|</span> <span class="p">(</span><span class="n">kmax</span> <span class="o">&lt;</span> <span class="n">knum</span><span class="p">)</span>

        <span class="c1">#frequency cutoff</span>
        <span class="k">if</span> <span class="n">fmin</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">|</span> <span class="p">(</span><span class="n">freq</span> <span class="o">&lt;</span> <span class="n">fmin</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fmax</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">|</span> <span class="p">(</span><span class="n">fmax</span> <span class="o">&lt;</span> <span class="n">freq</span><span class="p">)</span>

        <span class="c1">#dispersion filter</span>
        <span class="k">if</span> <span class="n">hmin</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">g</span><span class="o">*</span><span class="n">hmin</span><span class="p">)</span>
            <span class="n">omega</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">freq</span><span class="o">/</span><span class="mf">24.</span><span class="o">/</span><span class="mf">3600.</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">beta</span><span class="o">*</span><span class="n">c</span><span class="p">)</span> <span class="c1">#adusting day^-1 to s^-1</span>
            <span class="n">k</span>     <span class="o">=</span> <span class="n">knum</span><span class="o">/</span><span class="n">a</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">c</span><span class="o">/</span><span class="n">beta</span><span class="p">)</span>         <span class="c1">#adusting ^2pia to ^m</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">|</span> <span class="p">(</span><span class="n">omega</span> <span class="o">-</span> <span class="n">k</span> <span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">hmax</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">g</span><span class="o">*</span><span class="n">hmax</span><span class="p">)</span>
            <span class="n">omega</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">freq</span><span class="o">/</span><span class="mf">24.</span><span class="o">/</span><span class="mf">3600.</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">beta</span><span class="o">*</span><span class="n">c</span><span class="p">)</span> <span class="c1">#adusting day^-1 to s^-1</span>
            <span class="n">k</span>     <span class="o">=</span> <span class="n">knum</span><span class="o">/</span><span class="n">a</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">c</span><span class="o">/</span><span class="n">beta</span><span class="p">)</span>         <span class="c1">#adusting ^2pia to ^m</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">|</span> <span class="p">(</span><span class="n">omega</span> <span class="o">-</span> <span class="n">k</span> <span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">mask</span><span class="p">[:,</span><span class="n">NA</span><span class="p">,:],</span> <span class="n">nlat</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">fftdata</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="n">filterd</span> <span class="o">=</span> <span class="n">fftpack</span><span class="o">.</span><span class="n">ifft2</span><span class="p">(</span><span class="n">fftdata</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">filterd</span><span class="o">.</span><span class="n">real</span></div>


<div class="viewcode-block" id="KFfilter.erfilter">
<a class="viewcode-back" href="../../../modules.html#moaap.trackers.waves.KFfilter.erfilter">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">erfilter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kmin</span><span class="o">=-</span><span class="mi">10</span><span class="p">,</span> <span class="n">kmax</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">hmin</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">hmax</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;equatorial wave filter</span>

<span class="sd">        Arguments:</span>

<span class="sd">           &#39;fmin/fmax&#39; -- unit is cycle per day</span>

<span class="sd">           &#39;kmin/kmax&#39; -- zonal wave number</span>

<span class="sd">           &#39;hmin/hmax&#39; -- equivalent depth</span>

<span class="sd">           &#39;n&#39;         -- meridional mode number</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            &#39;filterd&#39; -- filtered data in the original data space</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;=</span><span class="mi">0</span> <span class="ow">or</span> <span class="n">n</span><span class="o">%</span><span class="mi">1</span> <span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;n must be n&gt;=1 integer&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

        <span class="n">fftdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fftdata</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">knum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">knum</span>
        <span class="n">freq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">freq</span>
        <span class="n">nf</span><span class="p">,</span> <span class="n">nlat</span><span class="p">,</span> <span class="n">nk</span> <span class="o">=</span> <span class="n">fftdata</span><span class="o">.</span><span class="n">shape</span>

        <span class="c1"># filtering ############################################################</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nf</span><span class="p">,</span><span class="n">nk</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="c1">#wavenumber cut-off</span>
        <span class="k">if</span> <span class="n">kmin</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">|</span> <span class="p">(</span><span class="n">knum</span> <span class="o">&lt;</span> <span class="n">kmin</span><span class="p">)</span> 
        <span class="k">if</span> <span class="n">kmax</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">|</span> <span class="p">(</span><span class="n">kmax</span> <span class="o">&lt;</span> <span class="n">knum</span><span class="p">)</span>

        <span class="c1">#frequency cutoff</span>
        <span class="k">if</span> <span class="n">fmin</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">|</span> <span class="p">(</span><span class="n">freq</span> <span class="o">&lt;</span> <span class="n">fmin</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fmax</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">|</span> <span class="p">(</span><span class="n">fmax</span> <span class="o">&lt;</span> <span class="n">freq</span><span class="p">)</span>

        <span class="c1">#dispersion filter</span>
        <span class="k">if</span> <span class="n">hmin</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">g</span><span class="o">*</span><span class="n">hmin</span><span class="p">)</span>
            <span class="n">omega</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">freq</span><span class="o">/</span><span class="mf">24.</span><span class="o">/</span><span class="mf">3600.</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">beta</span><span class="o">*</span><span class="n">c</span><span class="p">)</span>           <span class="c1">#adusting day^-1 to s^-1</span>
            <span class="n">k</span>     <span class="o">=</span> <span class="n">knum</span><span class="o">/</span><span class="n">a</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">c</span><span class="o">/</span><span class="n">beta</span><span class="p">)</span>                         <span class="c1">#adusting ^2pia to ^m               </span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">|</span> <span class="p">(</span><span class="n">omega</span><span class="o">*</span><span class="p">(</span><span class="n">k</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="n">k</span>  <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">hmax</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">g</span><span class="o">*</span><span class="n">hmax</span><span class="p">)</span>
            <span class="n">omega</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">freq</span><span class="o">/</span><span class="mf">24.</span><span class="o">/</span><span class="mf">3600.</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">beta</span><span class="o">*</span><span class="n">c</span><span class="p">)</span>           <span class="c1">#adusting day^-1 to s^-1</span>
            <span class="n">k</span>     <span class="o">=</span> <span class="n">knum</span><span class="o">/</span><span class="n">a</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">c</span><span class="o">/</span><span class="n">beta</span><span class="p">)</span>                         <span class="c1">#adusting ^2pia to ^m               </span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">|</span> <span class="p">(</span><span class="n">omega</span><span class="o">*</span><span class="p">(</span><span class="n">k</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="n">k</span>  <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">mask</span><span class="p">[:,</span><span class="n">NA</span><span class="p">,:],</span> <span class="n">nlat</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="n">fftdata</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="n">filterd</span> <span class="o">=</span> <span class="n">fftpack</span><span class="o">.</span><span class="n">ifft2</span><span class="p">(</span><span class="n">fftdata</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">filterd</span><span class="o">.</span><span class="n">real</span></div>


<div class="viewcode-block" id="KFfilter.igfilter">
<a class="viewcode-back" href="../../../modules.html#moaap.trackers.waves.KFfilter.igfilter">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">igfilter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kmin</span><span class="o">=-</span><span class="mi">15</span><span class="p">,</span> <span class="n">kmax</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">hmin</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">hmax</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;n&gt;=1 inertio gravirt wave filter. default is n=1 WIG.</span>

<span class="sd">        Arguments:</span>

<span class="sd">           &#39;fmin/fmax&#39; -- unit is cycle per day</span>

<span class="sd">           &#39;kmin/kmax&#39; -- zonal wave number. negative is westward, positive is</span>
<span class="sd">                          eastward</span>

<span class="sd">           &#39;hmin/hmax&#39; -- equivalent depth</span>

<span class="sd">           &#39;n&#39;         -- meridional mode number</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            &#39;filterd&#39; -- filtered data in the original data space</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;=</span><span class="mi">0</span> <span class="ow">or</span> <span class="n">n</span><span class="o">%</span><span class="mi">1</span> <span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;n must be n&gt;=1 integer. for n=0 EIG you must use eig0filter method.&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

        <span class="n">fftdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fftdata</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">knum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">knum</span>
        <span class="n">freq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">freq</span>
        <span class="n">nf</span><span class="p">,</span> <span class="n">nlat</span><span class="p">,</span> <span class="n">nk</span> <span class="o">=</span> <span class="n">fftdata</span><span class="o">.</span><span class="n">shape</span>

        <span class="c1"># filtering ############################################################</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nf</span><span class="p">,</span><span class="n">nk</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="c1">#wavenumber cut-off</span>
        <span class="k">if</span> <span class="n">kmin</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">|</span> <span class="p">(</span><span class="n">knum</span> <span class="o">&lt;</span> <span class="n">kmin</span><span class="p">)</span> 
        <span class="k">if</span> <span class="n">kmax</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">|</span> <span class="p">(</span><span class="n">kmax</span> <span class="o">&lt;</span> <span class="n">knum</span><span class="p">)</span>

        <span class="c1">#frequency cutoff</span>
        <span class="k">if</span> <span class="n">fmin</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">|</span> <span class="p">(</span><span class="n">freq</span> <span class="o">&lt;</span> <span class="n">fmin</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fmax</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">|</span> <span class="p">(</span><span class="n">fmax</span> <span class="o">&lt;</span> <span class="n">freq</span><span class="p">)</span>

        <span class="c1">#dispersion filter</span>
        <span class="k">if</span> <span class="n">hmin</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">g</span><span class="o">*</span><span class="n">hmin</span><span class="p">)</span>
            <span class="n">omega</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">freq</span><span class="o">/</span><span class="mf">24.</span><span class="o">/</span><span class="mf">3600.</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">beta</span><span class="o">*</span><span class="n">c</span><span class="p">)</span>           <span class="c1">#adusting day^-1 to s^-1</span>
            <span class="n">k</span>     <span class="o">=</span> <span class="n">knum</span><span class="o">/</span><span class="n">a</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">c</span><span class="o">/</span><span class="n">beta</span><span class="p">)</span>                         <span class="c1">#adusting ^2pia to ^m               </span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">|</span> <span class="p">(</span><span class="n">omega</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">k</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>  <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">hmax</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">g</span><span class="o">*</span><span class="n">hmax</span><span class="p">)</span>
            <span class="n">omega</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">freq</span><span class="o">/</span><span class="mf">24.</span><span class="o">/</span><span class="mf">3600.</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">beta</span><span class="o">*</span><span class="n">c</span><span class="p">)</span>           <span class="c1">#adusting day^-1 to s^-1</span>
            <span class="n">k</span>     <span class="o">=</span> <span class="n">knum</span><span class="o">/</span><span class="n">a</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">c</span><span class="o">/</span><span class="n">beta</span><span class="p">)</span>                         <span class="c1">#adusting ^2pia to ^m               </span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">|</span> <span class="p">(</span><span class="n">omega</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">k</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>  <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">mask</span><span class="p">[:,</span><span class="n">NA</span><span class="p">,:],</span> <span class="n">nlat</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">fftdata</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        
        <span class="n">filterd</span> <span class="o">=</span> <span class="n">fftpack</span><span class="o">.</span><span class="n">ifft2</span><span class="p">(</span><span class="n">fftdata</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">filterd</span><span class="o">.</span><span class="n">real</span></div>


<div class="viewcode-block" id="KFfilter.eig0filter">
<a class="viewcode-back" href="../../../modules.html#moaap.trackers.waves.KFfilter.eig0filter">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">eig0filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fmax</span><span class="o">=</span><span class="mf">0.55</span><span class="p">,</span> <span class="n">kmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">kmax</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">hmin</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">hmax</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;n&gt;=0 eastward inertio gravirt wave filter.</span>

<span class="sd">        Arguments:</span>

<span class="sd">           &#39;fmin/fmax&#39; -- unit is cycle per day</span>

<span class="sd">           &#39;kmin/kmax&#39; -- zonal wave number. negative is westward, positive is</span>
<span class="sd">                          eastward</span>

<span class="sd">           &#39;hmin/hmax&#39; -- equivalent depth</span>

<span class="sd">        Returns:</span>
<span class="sd">            &#39;filterd&#39; -- filtered data in the original data space</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">kmin</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;kmin must be positive. if k &lt; 0, this mode is MRG&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

        <span class="n">fftdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fftdata</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">knum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">knum</span>
        <span class="n">freq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">freq</span>
        <span class="n">nf</span><span class="p">,</span> <span class="n">nlat</span><span class="p">,</span> <span class="n">nk</span> <span class="o">=</span> <span class="n">fftdata</span><span class="o">.</span><span class="n">shape</span>

        <span class="c1"># filtering ############################################################</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nf</span><span class="p">,</span><span class="n">nk</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="c1">#wavenumber cut-off</span>
        <span class="k">if</span> <span class="n">kmin</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">|</span> <span class="p">(</span><span class="n">knum</span> <span class="o">&lt;</span> <span class="n">kmin</span><span class="p">)</span> 
        <span class="k">if</span> <span class="n">kmax</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">|</span> <span class="p">(</span><span class="n">kmax</span> <span class="o">&lt;</span> <span class="n">knum</span><span class="p">)</span>

        <span class="c1">#frequency cutoff</span>
        <span class="k">if</span> <span class="n">fmin</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">|</span> <span class="p">(</span><span class="n">freq</span> <span class="o">&lt;</span> <span class="n">fmin</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fmax</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">|</span> <span class="p">(</span><span class="n">fmax</span> <span class="o">&lt;</span> <span class="n">freq</span><span class="p">)</span>

        <span class="c1">#dispersion filter</span>
        <span class="k">if</span> <span class="n">hmin</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">g</span><span class="o">*</span><span class="n">hmin</span><span class="p">)</span>
            <span class="n">omega</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">freq</span><span class="o">/</span><span class="mf">24.</span><span class="o">/</span><span class="mf">3600.</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">beta</span><span class="o">*</span><span class="n">c</span><span class="p">)</span>           <span class="c1">#adusting day^-1 to s^-1</span>
            <span class="n">k</span>     <span class="o">=</span> <span class="n">knum</span><span class="o">/</span><span class="n">a</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">c</span><span class="o">/</span><span class="n">beta</span><span class="p">)</span>                         <span class="c1">#adusting ^2pia to ^m               </span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">|</span> <span class="p">(</span><span class="n">omega</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">k</span><span class="o">*</span><span class="n">omega</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">hmax</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">g</span><span class="o">*</span><span class="n">hmax</span><span class="p">)</span>
            <span class="n">omega</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">freq</span><span class="o">/</span><span class="mf">24.</span><span class="o">/</span><span class="mf">3600.</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">beta</span><span class="o">*</span><span class="n">c</span><span class="p">)</span>           <span class="c1">#adusting day^-1 to s^-1</span>
            <span class="n">k</span>     <span class="o">=</span> <span class="n">knum</span><span class="o">/</span><span class="n">a</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">c</span><span class="o">/</span><span class="n">beta</span><span class="p">)</span>                         <span class="c1">#adusting ^2pia to ^m               </span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">|</span> <span class="p">(</span><span class="n">omega</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">k</span><span class="o">*</span><span class="n">omega</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">mask</span><span class="p">[:,</span><span class="n">NA</span><span class="p">,:],</span> <span class="n">nlat</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">fftdata</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="n">filterd</span> <span class="o">=</span> <span class="n">fftpack</span><span class="o">.</span><span class="n">ifft2</span><span class="p">(</span><span class="n">fftdata</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">filterd</span><span class="o">.</span><span class="n">real</span></div>


<div class="viewcode-block" id="KFfilter.mrgfilter">
<a class="viewcode-back" href="../../../modules.html#moaap.trackers.waves.KFfilter.mrgfilter">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">mrgfilter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kmin</span><span class="o">=-</span><span class="mi">10</span><span class="p">,</span> <span class="n">kmax</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">hmin</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">hmax</span><span class="o">=</span><span class="mi">90</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;mixed Rossby gravity wave</span>

<span class="sd">        Arguments:</span>

<span class="sd">           &#39;fmin/fmax&#39; -- unit is cycle per day</span>

<span class="sd">           &#39;kmin/kmax&#39; -- zonal wave number. negative is westward, positive is</span>
<span class="sd">                          eastward</span>

<span class="sd">           &#39;hmin/hmax&#39; -- equivalent depth</span>

<span class="sd">        Returns:</span>
<span class="sd">            &#39;filterd&#39; -- filtered data in the original data space</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">kmax</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;kmax must be negative. if k &gt; 0, this mode is the same as n=0 EIG&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
            
        <span class="n">fftdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fftdata</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">knum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">knum</span>
        <span class="n">freq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">freq</span>
        <span class="n">nf</span><span class="p">,</span> <span class="n">nlat</span><span class="p">,</span> <span class="n">nk</span> <span class="o">=</span> <span class="n">fftdata</span><span class="o">.</span><span class="n">shape</span>

        <span class="c1"># filtering ############################################################</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nf</span><span class="p">,</span><span class="n">nk</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="c1">#wavenumber cut-off</span>
        <span class="k">if</span> <span class="n">kmin</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">|</span> <span class="p">(</span><span class="n">knum</span> <span class="o">&lt;</span> <span class="n">kmin</span><span class="p">)</span> 
        <span class="k">if</span> <span class="n">kmax</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">|</span> <span class="p">(</span><span class="n">kmax</span> <span class="o">&lt;</span> <span class="n">knum</span><span class="p">)</span>

        <span class="c1">#frequency cutoff</span>
        <span class="k">if</span> <span class="n">fmin</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">|</span> <span class="p">(</span><span class="n">freq</span> <span class="o">&lt;</span> <span class="n">fmin</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fmax</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">|</span> <span class="p">(</span><span class="n">fmax</span> <span class="o">&lt;</span> <span class="n">freq</span><span class="p">)</span>

        <span class="c1">#dispersion filter</span>
        <span class="k">if</span> <span class="n">hmin</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">g</span><span class="o">*</span><span class="n">hmin</span><span class="p">)</span>
            <span class="n">omega</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">freq</span><span class="o">/</span><span class="mf">24.</span><span class="o">/</span><span class="mf">3600.</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">beta</span><span class="o">*</span><span class="n">c</span><span class="p">)</span>           <span class="c1">#adusting day^-1 to s^-1</span>
            <span class="n">k</span>     <span class="o">=</span> <span class="n">knum</span><span class="o">/</span><span class="n">a</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">c</span><span class="o">/</span><span class="n">beta</span><span class="p">)</span>                         <span class="c1">#adusting ^2pia to ^m               </span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">|</span> <span class="p">(</span><span class="n">omega</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">k</span><span class="o">*</span><span class="n">omega</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">hmax</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">g</span><span class="o">*</span><span class="n">hmax</span><span class="p">)</span>
            <span class="n">omega</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">freq</span><span class="o">/</span><span class="mf">24.</span><span class="o">/</span><span class="mf">3600.</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">beta</span><span class="o">*</span><span class="n">c</span><span class="p">)</span>           <span class="c1">#adusting day^-1 to s^-1</span>
            <span class="n">k</span>     <span class="o">=</span> <span class="n">knum</span><span class="o">/</span><span class="n">a</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">c</span><span class="o">/</span><span class="n">beta</span><span class="p">)</span>                         <span class="c1">#adusting ^2pia to ^m               </span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">|</span> <span class="p">(</span><span class="n">omega</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">k</span><span class="o">*</span><span class="n">omega</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">mask</span><span class="p">[:,</span><span class="n">NA</span><span class="p">,:],</span> <span class="n">nlat</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">fftdata</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="n">filterd</span> <span class="o">=</span> <span class="n">fftpack</span><span class="o">.</span><span class="n">ifft2</span><span class="p">(</span><span class="n">fftdata</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">filterd</span><span class="o">.</span><span class="n">real</span></div>


<div class="viewcode-block" id="KFfilter.tdfilter">
<a class="viewcode-back" href="../../../modules.html#moaap.trackers.waves.KFfilter.tdfilter">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">tdfilter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kmin</span><span class="o">=-</span><span class="mi">20</span><span class="p">,</span> <span class="n">kmax</span><span class="o">=-</span><span class="mi">6</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;KTH05 TD-type filter.</span>

<span class="sd">        Arguments:</span>

<span class="sd">           &#39;fmin/fmax&#39; -- unit is cycle per day</span>

<span class="sd">           &#39;kmin/kmax&#39; -- zonal wave number. negative is westward, positive is</span>
<span class="sd">                          eastward</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            &#39;filterd&#39; -- filtered data in the original data space</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fftdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fftdata</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">knum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">knum</span>
        <span class="n">freq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">freq</span>
        <span class="n">nf</span><span class="p">,</span> <span class="n">nlat</span><span class="p">,</span> <span class="n">nk</span> <span class="o">=</span> <span class="n">fftdata</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nf</span><span class="p">,</span><span class="n">nk</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>

        <span class="c1">#wavenumber cut-off</span>
        <span class="k">if</span> <span class="n">kmin</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">|</span> <span class="p">(</span><span class="n">knum</span> <span class="o">&lt;</span> <span class="n">kmin</span><span class="p">)</span> 
        <span class="k">if</span> <span class="n">kmax</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">|</span> <span class="p">(</span><span class="n">kmax</span> <span class="o">&lt;</span> <span class="n">knum</span><span class="p">)</span>

        <span class="c1">#frequency cutoff</span>
        <span class="k">if</span> <span class="n">fmin</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">|</span> <span class="p">(</span><span class="n">freq</span> <span class="o">&lt;</span> <span class="n">fmin</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fmax</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">|</span> <span class="p">(</span><span class="n">fmax</span> <span class="o">&lt;</span> <span class="n">freq</span><span class="p">)</span>

        <span class="c1">#dispersion filter</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">|</span> <span class="p">(</span><span class="mi">84</span><span class="o">*</span><span class="n">freq</span><span class="o">+</span><span class="n">knum</span><span class="o">-</span><span class="mi">22</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">210</span><span class="o">*</span><span class="n">freq</span><span class="o">+</span><span class="mf">2.5</span><span class="o">*</span><span class="n">knum</span><span class="o">-</span><span class="mi">13</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>                                                                                         
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">mask</span><span class="p">[:,</span><span class="n">NA</span><span class="p">,:],</span> <span class="n">nlat</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">fftdata</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="n">filterd</span> <span class="o">=</span> <span class="n">fftpack</span><span class="o">.</span><span class="n">ifft2</span><span class="p">(</span><span class="n">fftdata</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">filterd</span><span class="o">.</span><span class="n">real</span></div>
</div>



</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Andreas F. Prein, Raphael Graf.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>